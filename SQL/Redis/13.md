## Redis-管理 笔记-13

> ##
> ### 目录
> 1. 持久化
> 1.1 RDB方式
> 1.2 AOF方式
> 2. 复制
> 2.1 配置
> 2.2 原理
> 2.3 图结构
> 2.4 读写分离
> 2.5 从数据库持久化
> 3. 安全
> 3.1 可信的环境
> 3.2 数据库密码
> 3.3 命令重命名
> 4. 通信协议
> 4.1 简单协议
> 4.2 统一请求协议
> 5. 管理工具
> 5.1 redis-cli
> 5.2 GUI工具
> ##

---

### 前言

Redis的数据都是存储在内存中，那么如果服务器重启了，Redis的数据如何恢复，以及如何给Redis设置密码以防止未经授权的客户端连接。本页笔记将会讲解Redis的管理知识，包括持久化、复制和安全内容，还会介绍些三方的Redis管理工具。

#### 1. 持久化

Redis的高性能很大程度上是由于数据存储在内存中，为了使Redis在重启后仍能保证数据不丢失，需要将数据从内存中以某种方式同步到硬盘，这一过程就是数据持久化。

Redis支持两种方式的持久化，分别是RDB和AOF。可以单独使用或2者结合使用。

#### 1.1 RDB方式

RDB方式的持久化是通过快照(snapshotting)完成的，当符合一定条件时Redis会自动将内存中的所有数据进行快照并存储在硬盘上。

RDB是Redis默认采用的持久化方式。在配置文件(redis同级目录下的redis.conf文件)中已经配置了3个条件
```
# 900s-15分钟内至少有1个键被更改就快照
save 900 1

# 300s-5分钟内至少有10个键被更改就快照
save 300 10

# 60s-1分钟内至少有1w个键被更改就快照
save 60 10000
```

禁用自动快照需要修改配置文件，找到以上几行并删除即可。

手动快照
```
# 由当前主进程进行快照，会阻塞其他请求
redis> SAVE

# fork子进程进行快照，非阻塞主进程
redis> BGSAVE [schedule]
```

Redis默认会将快照文件存储在当前目录的dump.rdb文件中，可以通过修改配置文件中dir和dbfilename来自定义
```
# 快照存储路径
dir ./

# 快照文件名
dbfilename dump.rdb
```
>##
>实现快照的过程
>
>1.fork函数复制一份当前进程的副本。
>
>2.父进程继续接收并处理客户端发来的命令，子进程开始将内存数据写入硬盘中的临时文件。
>
>3.当子进程写入完所有数据后会用该临时文件替换旧的.rdb文件。
>##

在执行fork的时候操作系统（类Unix）会使用写时复制（copy-on-write）策略，即父子进程公用统一块内存数据，当父进程要修改某片数据的时候，操作系统会将片数据复制一份来保证子进程的数据不受影响，所以新的RDB文件存储的是执行fork那一刻的内存数据。

通过上面的流程可以发现Redis在进行快照的时候不会修改RDB文件，只有快照流程结束的时候才会将旧的文件替换成新的，保证了任何时候RDB文件都是完整的。使得我们可以通过定时备份RDB文件来实现redis数据库的备份。

RDB文件是经过压缩的（可以通过配置rdbcompression参数来禁用压缩节省CPU占用）的二进制格式，所以占用的空间会小于内存中的数据大小，更加利于传输。

Redis启动后会自动读取RDB文件，将数据从硬盘载入内存，一般来说讲一个大小1GB、1千万个字符串类型键的快照文件载入内存需要20～30s。

通过RDB方式实现持久化，一旦Redis异常退出，就会丢失最后一次快照之后更改的所有数据。此时需要根据具体的应用场景，通过组合设置自动快照的条件来将可能发生的数据损失控制在能接受的范围。

#### 1.2 AOF方式

AOF持久化会在每执行一条会更改Redis中数据的命令时，就将该命令写入硬盘中的AOF文件。

默认情况下Redis没有开启AOF(append only file)方式的持久化，通过appendonly参数开启:
```
appendonly yes
```

AOF文件的保存位置和RDB文件的位置相同，都是通过dir参数设置，文件名是通过appendfilename参数设置（默认是appendonly.aof）
```
# aof存储路径
dir ./

# aof文件名
appendfilename appendonly.aof
```

开启AOF持久化之后，在客户端进行写入操作的时候对应的aof文件就会进行命令同步
```
set foo 1
set foo 2
set foo 3
```
当执行了这三条命令之后，aof文件也同步的更新了。文件类型是纯文本，内容是客户端向服务器发送的原始通信协议的内容。

针对以上3条命令执行的修改，前两条命令是冗余的，会被第三条命令覆盖。（操作是无意义的）随着执行的命令越来越多，AOF文件的大小也会越来大，即使内存中的实际数据可能没有多少。所以Redis会进行自动优化AOF文件，通过满足conf的参数配置条件来触发重写。
```
# 表示当前AOF文件大小超过上一次重写的AOF文件大小的百分之多少时触发重写
auto-aof-rewrite-percentage 100

# 限制了允许重写的最小AOF文件大小
auto-aof-rewrite-min-size 64mb
```

可以通过命令去手动执行重写
```
BGREWRITEAOF
```

启动Redis时候会逐个执行AOF文件中的命令来将硬盘中的数据载入内存中，载入的速度相较与RDB会慢一些。

每次执行修改数据库内容的操作时，AOF都会将命令记录在AOF文件中，事实上，由于操作系统的缓存机制，数据并没有真正写入硬盘，而是进入了硬盘缓存，默认是每30s执行一次同步，如果通过的过程中出现系统异常导致硬盘缓存的数据丢失了，对于使用AOF持久化的应用是无法接受的。Redis可以通过设置appendfsync参数来修改同步的时机
```
# 默认情况下redis采用的是everysec
appendfsync everysec

# appendfsync always
# appendfsync no
```
everysec表示每秒执行一次同步操作。always表示每次写入都会同步，这是最安全也是最慢的。no表示不主动同步操作，完全交给操作系统（30s），这是最快但也是最不安全的。一般情况下everysec就足够了，即兼顾了性能又保证了安全。

Redis允许同时开启AOF和RDB，即保证了数据安全的同时也可以进行备份等操作。此时重启Redis，会使用AOF文件来恢复操作，因为AOF方式持久化可能丢失的数据更少。

---

#### 2. 复制

持久化是保证单台服务器重启的情况下，也不会损失或少量损失数据。但如果服务器的硬盘出现故障也会导致数据丢失。为了避免单点故障，我们希望将数据复制到多个副本以部署在不同的服务器上，即使一台出现了故障，其他服务器依然可以继续提供服务。这就要求当一台服务器上的数据库更新后，可以自动将更新的数据同步到其他服务器上，Redis提供了复制（replication）功能可以自动实现同步的过程。

#### 2.1 配置

同步后的数据库分为2类，一类是主数据库（master），一类是从数据库（slave）。一般主数据库负责读写操作，从数据库只读。主从模式是1对多。

Redis使用复制功能很容易，只要在从数据库的配置文件中加入
```
# ip port 是主数据库的
slaveof ip:port
```
而主数据库不需要进行任何的配置。

例如
```
master> redis-server
slave[1]> redis-server --port 6380 --slaveof 127.0.0.1 6379

master> redis-cli
master> set foo 1
OK

slave[1]> redis-cli -p 6380
slave[1]> get foo
"1"
```

默认情况下从数据库不能写，会报错，可以通过设置配置文件的
```
slave-ready-only no
```
来开启写操作，但写入不会影响其他从数据库，而且一旦主数据库写入同样键值的新值，该从库的数据会被覆盖掉。

通过命令设置从数据库
```
redis 6380> SLAVEOF 127.0.0.1 6379
```
如果该数据库已经是某个主库的从库了，那么SLAVEOF命令会定制和原来的主库同步转而改为和新的主库同步。还可以使用
```
SLAVEOF NO ONE
```
该命令表示，让当前的库放弃和其他库同步，转而升级为主库

#### 2.2 原理

当一个从数据库启动的时候，会向主数据库发送SYNC命令，主库接收到命令后会开始在后台保存快照（即RDB持久化操作），并将保存期间接受到的命令缓存起来。当快照完成后，Redis会将快照文件和所有缓存的命令发送给从库。从库收到后，进行载入快照文件并执行收到的缓存的命令。当主库断开重连后会重新执行上述操作，不支持断点续传。

由于Redis服务器使用的是TCP协议通信的。可以用telnet来测试
```
telnet host port
> PING
+PONG
> REPLCONF listening-port port
+OK
> SYNC
...(开始同步)
```
同步完成后，主库的写操作，就会同步到从库（同步的内容就是用Redis通信协议传输入的原始数据）

注意的是，同步的过程中，从库是可以继续处理客户端的请求的。默认情况下，从库使用的是同步前的数据作为响应。可以通过配置参数
```
salve-serve-stale-data no
```
来让从库在同步完成前对所有命令都回复错误"SYNC with master in progress."

在复制过程中，快照无论在主库还是从库中都起了很大作用，只要执行复制就会进行快照，即使我们关闭了RDB方式的持久化（删除save参数）。进一步说，无论是否启用了RDB，Redis在启动的时候都会尝试读取dir和dbfilename2个参数指定的RDB文件来恢复数据库。

#### 2.3 图结构

一个数据库不仅可以做从库，也可以做主库
```
masterA
├── slaveB
│   ├── slaveE
│   └── slaveF
├── slaveC
└── slaveD
```
如上面的主从集群结构，主库A写入数据会同步给从库BCD，而从库B的数据将同步给从库EF，当从库B写入数据的时候不会同步给从库CD，只会同步给从库EF。

#### 2.4 读写分离

通过复制可以实现读写分离以提高服务器的负载能力，常见场景中，读的频率大于写的，当单机Redis服务器无法应付大量的读请求时（尤其是耗资源的请求，如SORT命令）可以通过复制来建立多个从库，主库只处理写操作，而从库负责读操作。

#### 2.5 从数据库持久化

持久化是相对耗时的操作，为了提高性能，通过复制建立若干个从库，并在从库开启持久化，主库禁用持久化。

当从库崩溃时重启后主库的数据会自动同步过来（连接后自动发送SYNC）。

当主库崩溃时，可以在从库上执行"SLAVEOF NO ONE"命令让其升级为主库，并在原来的主库重启时使用"SLAVEOF host port"命令称为新主库的从库，这样就自动的把主库的数据同步过来了。

---

#### 3. 安全

Redis的作者设计这门语言的时候，提到Redis以简洁为美。同样在安全层面Redis也没有做太多的工作。

#### 3.1 可信的环境

Redis的安全设计是在"Redis运行在可信环境"为基础下提出的。在生产环境运行时不能允许外界直接连接到Redis服务器，而应该通过应用程序来进行中转，运行在可信的环境是保证Redis安全的最重要法则。
```
外网 -> 防火墙 -> 内网后台服务器 -> 内网Redis数据库
```
通过设置配置参数bind，来限制只允许本机应用连接Redis
```
bind 127.0.0.1
```

通过防火墙能更自由的设置访问规则。

#### 3.2 数据库密码

除部署可信的环境之外，还可以通过配置文件的requirepass参数设置Redis密码，例如
```
requirepass TAFK（@~!ji^XASQD2A3JK4SHD123）
```
客户端每次连接到Redis时都需要发送密码，否则Redis会拒绝执行客户端发来的命令(访问会报错ERR operation not permitted)

发送密码需要使用AUTH命令
```
AUTH password
```
由于Redis性能极高，并且在输入错误密码后Redis并不会进行主动延迟，所以攻击者可以通过穷举法破解Redis密码（1s可以尝试十几万个密码），因此设置的时候要选择复杂的密码。

如果主库配置了密码，则需要从库们在配置文件
```
masterauth password
```
来设置主库的密码，以使从库连接主库时自动使用AUTH命令认证。

#### 3.3 命令重命名

Redis支持在配置文件将命令重命名，例如
```
rename-command FLUSHALL newCommandName
```
如果希望禁用某个命令直接将命令命名为空字符串即可
```
rename-command FLUSHALL ""
```

---

#### 4. 通信协议

Redis通信协议是Redis客户端与Redis之间交流的语言，通信协议规定了命令和返回值格式。了解Redis通信协议后不仅可以理解AOF文件的格式和主从复制时主库向从库发的内容等，还可以自己开发一个Redis客户端。

Redis支持两种通信协议，一种是二进制安全的统一请求协议（unified request protocol），一种是比较直观的便于在telnet程序中输入的简单协议。这两种协议只是命令的格式有区别，命令返回值的格式是一样的。

#### 4.1 简单协议

简单协议适合在telnet程序中和Redis通信。

命令格式就是将命令和各个参数用**空格**分开。如
```
EXISTS foo
SET foo bar
..
```
由于Redis解析简单协议时只是简单以空格分隔，所以无法输入二进制字符。

使用telnet测试
```
telnet 127.0.0.1 6379
SET foo bar
GET foo
LPUSH plist 1 2 3
LRANGE plist 0 -1
ERRORCOMMAND
```
对于Redis的5种返回值类型的格式，在redis-cli中显示的是处理过数据，而telnet中显示的是Redis真正返回的格式，下面将介绍每一种返回的格式

1.错误回复
以“-”开头，后面跟上错误信息以"\r\n"结尾
```
-ERR unkonw command "ERRORCOMMAND"
```
2.状态回复
以“+”开头，后面跟上状态信息以"\r\n"结尾
```
+OK
```
3.整数回复
以“：”开头，后面跟上数字以"\r\n"结尾
```
:3
```
4.字符串回复
以"$"开头，后面跟上字符串长度和内容，之间用\r\n分隔
```
$3
bar
$-1 -> nil
```
5.多行字符串回复
以"*"开头，后面跟上字符串数组的组数，后面是字符串们
```
*3
$3
bar
$1
a
```

#### 4.2 统一请求协议

统一请求协议的命令格式和多字符串回复的格式类似，如
```
# SET foo bar的统一请求格式
*3\r\n $3\r\nSET\r\n $3\r\nfoo\r\n $3\r\nbar\r\n
```
同样发送命令时指定了后面字符串的长度，所以命令的每个参数都可以包含二进制的字符。统一请求协议的返回值格式和简单协议一样。

Redis的AOF文件和主从复制时主库向从库发送的内容都使用了统一请求协议。如果要开发一个和Redis直接通信的客户端，推荐使用统一请求协议。

---

#### 5. 管理工具

使用Redis时，用管理工具可以大大提高我们的开发效率和管理能力。

#### 5. redis-cli

Redis自带的命令行客户端，可以在任何安装Redis的服务器中找到redis-cli。对于管理Redis而言是最简单实用的工具。

redis-cli可以执行大部分Redis命令，包括查看数据信息INFO命令，修改配置的CONFIG命令以及强制快照的SAVE命令等，下面介绍几个管理Redis时非常有用的命令。

**耗时命令日志**

当一条命令执行时间超过限制时，Redis会将该命令的执行时间等信息直接加入耗时命令日志中(slow log)以供开发者查看。通过配置文件的
```
slowlog-log-slower-than 10000
```
参数设置这一限制，要注意单位是微秒（1000000微秒等于1秒），默认是10000。

耗时命令日志存储在内存中，可以通过配置文件的
```
slowlog-max-len
```
参数来限制记录的条数。

通过命令SLOWLOG GET命令来获得当前的耗时命令日志
```
SLOWLOG GET
```

可以设置“slowlog-log-slower-than 0“来测试，设置为负数则会关闭耗时命令日志。

每条日志都由以下4部分组成

1.  该日志唯一ID
2.  该命令执行时的UNIX时间
3.  命令耗时时间，单位微秒
4.  命令及参数

**命令监控**

Redis提供了MONITOR命令来监控Redis执行的所有命令, redis-cli同样支持这个命令
```
MONITOR
```
这时Redis执行的任何命令都会在redis-cli打印出来。（可以打开另一个redis-cli执行一条命令来进行测试）

MONITOR命令非常影响Redis性能，一个客户端使用MONITOR命令会令Redis的负载能力降低近一半。所以该命令只适合用来调试和纠错。

Instagram团队开发了一个基于MONITOR命令的redis查询分析程序redis-faina。它可以根据MONITOR命令的监控结果分析出最常用的命令、访问最频繁的键等信息，对了解Redis的使用情况帮助很大。

redis-faina项目地址是<a href="https://github.com/Instagram/redis-faina">https://github.com/Instagram/redis-faina</a>直接下载其中的redis-faina.py文件即可使用。

redis-faina.py的输入值为一段时间的MONITOR命令执行结果。
```
redis-cli MONITOR | head -n 要分析的命令行数 | redis-faina.py
```

#### 5. GUI工具

当Redis中键较多时，使用redis-cli管理起来不是很方便，这时候可以使用一个图形化界面更加直观方便的进行数据管理。

直接上链接。文章作者整理了当下收费、不收费、cs、bs、IDE插件等各种类型的可视化工具。<a href="https://zhuanlan.zhihu.com/p/342793230">跳转文章</a>