## Redis-事务 笔记-06

> ##
> ### 目录
> 1. 概述
> 2. 错误处理
> 3. WATCH命令
> ##

---

#### 1. 概述

Redis中的事务(transaction)是一组命令的集合。事务同命令一样都是Redis的最小执行单位，一个事务要么都执行，要么都不执行。

使用的方式如下
```
MULTI
SQL语句1 -> QUEUED
SQL语句2 -> QUEUED
...
EXEC
```
使用MULTI命令高速Redis之后的命令都同属于同一个事务，先暂缓到队列中不执行。当执行EXEC命令键入的时候，才依次执行队列的任务。

事务的操作是原子级别的，要么都执行，要么都不执行。如果在执行EXEC命令前，客户端中断了，则Redis会清空事务队列，事务中的命令都不会执行。

#### 2. 错误处理

首先要知道有哪些导致错误的情况。

+ 语法错误（静态检测）
    语法错误是指命令不存在或者命令参数个数不对。只要有一个命令有语法错误，执行EXEC命令就会直接返回错误。连正确的也不会执行。（在Redis2.6.5之前正确的会执行）
    >
+ 运行错误（动态检测）
    运行错误是指在命令执行时出现的错误，譬如用散列类型的命令操作集合类型的key，这种错误在实际执行之前是无法发现的，所以事务时会执行的。如果一条出错，其他的命令依然会继续执行。

由于Redis不支持回滚功能，导致事务执行失败的2种错误中，语法的错误是在开发过程中就可以纠正的，像运行时这种错误需要更好的规划数据库的使用，保证使用的时候不出现类型操作错误。

#### 3. WATCH命令

对于Redis中的事务，执行过程中一条SQL语句的返回（如GET key命令）结果是与后续（一条或几条）
的SQL语句是依赖关系，且被使用。则需要设定一套机制保证，后续使用的过程中，依赖的结果不被其他服务进行修改。需要引入WATCH命令的概念，WATCH命令类似一个锁变量，含义是当通过WATCH命令给一个（或多个）key添加上监控后，一旦其中一个键被修改或删除，之后的事务就不会执行。监控一直持续到EXEC命令执行才结束。

语法
```
WATCH key
```

例如
```
> set user joe
> watch user
> set user noash
> multi
> set user modify_joe
> exec
> get user
"noash"
```
返回的是"noash"而不是"modify_joe"

由于事务中的命令是在EXEC命令后执行的，所以在MULTI命令后可以修改WATCH监控的键，例如
```
> set user joe
> watch user
> multi
> set user noash
> exec
> get user
"noash"
```

需要注意的是由于WATCH命令的作用只是当被监控的键值被修改后阻止之后一个事务的执行，所以，如果此时同一时间有多个客户端进行连接并进行修改watch的key，就不能保证其他客户端事务执行过程中的key的值是我们预期的，所以需要我们在EXEC执行失败后重新执行我们设计的流程。

执行EXEC命令会取消对所有键的监控，如果不想执行事务中的命令而取消监控的话可以使用UNWATCH命令。

例如
```
UNWATCH
```