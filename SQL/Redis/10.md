## Redis-管道及节省空间 笔记-10

> ##
> ### 目录
> 1. 管道概述
> 2. 管道实践
> 3. 精简键名和键值
> 4. 内部编码优化
> ##

---

#### 1. 管道概述

客户端和Redis使用TCP协议进行连接。不论客户端向Redis发送命令，还是Redis向客户端返回结果，都需要经过网络传输，这两部分的总耗时称为往返时延。根据网络性能不同，往返时延也不同，大致来说到本地回环地址(loop backaddress)的往返时延在数量级上相当于Redis处理一条简单命令的时间。如果执行较多的命令，每个命令的往返时延累加起来对性能还是有影响的。

在执行多个命令时每条命令都需要等待上一条命令执行完毕，即使命令不需要上一条命令的执行结果。

Redis的底层通信协议对管道（pipelining）提供了支持。通过管道可以一次性发送多条命令并在执行完后一次性将结果返回，当一组命令互相不依赖彼此的执行结果时候就可以将这组命令一起通过管道发出。管道通过减少客户端与Redis的通信次数来降低往返时延累计值的目的。

---

#### 2. 管道实践

Redis的管道在linux下可以使用echo和nc命令来进行测试，在windows下可以使用type和nc命令来进行测试。无论哪个环境，nc都要单独安装。

先介绍下nc，nc是一个网络工具，被称为"瑞士军刀"。从02年开始就出现至今一直被用于网络测试、网络安全等方面。

<b></b>
```
# macOS
> brew install nc

# linux
yum install nc -y
```

安装完成后，通过nc向Redis服务器进行数据发送的
```
nc localhost 6379
keys *
...(可键入其他Redis命令)
```
6379是Redis的默认端口,可以通过之前提到的CONFIG命令来进行查看
```
CONFIG GET PORT
```

<b>尝试用pipe+nc进行redis的数据写入</b>

```
> echo -e "set test1000 1000\n incr test1000\n get test1000" | nc localhost 6379
+OK
:1001
$4
1001
> redis-cli get test1000
"1001"
```
返回1001字符串说明已经成功写入并修改数据了。

<b>Redis的管道参数</b>

pipe参数
```
redis-cli --pipe
```

pipe命令的说明
```
--pipe Transfer raw Redis protocol from stdin to server
```
将原始的Redis协议从标准输入中传输到服务器。

一般我们需要一个txt或者csv文件写入一组命令然后保存到一个文件,例如我们创建一个batchSetUsers.txt，然后执行以下命令
```
cat batchSetUsers.txt | redis-cli --pipe
```
这样就通过redis提供的管道技术批量的完成了一组命令。

管道可以大量插入数据，也可以从文件中批量插入数据。对于我们要手动为系统缓存一些数据到Redis时，就可以通过MySQL或其他数据库进行查询，然后通过管道来导入到Redis内。

---

<h3>前言</h3>

内存变得越来越便宜，以后内存可能成为新的硬盘。但即便如此内存在今天看来仍然很昂贵。而Redis是一个基于内存的数据库，所有的数据都存储在内存中，所以如何优化存储，减少内存空间占用对成本控制来说十分重要。
#### 3. 精简键名和键值

精简键名和键值是最直观的减少内存占用的方式。当然精简的键名一定要把握好尺度，不能单纯为了节约空间而使其变得不容易理解和维护（命名冲突）。

---

#### 4. 内部编码优化

有时候通过命名压缩的空间也已经不满足需求了，这时候就需要根据Redis内部编码规则来节省更多的空间。

Redis为每种数据类型都提供了2种内部编码方式，以散列类型为例，散列类型是通过散列表实现的，时间复杂度是O(1)，然而键中元素很少的时候O(1)并不会比O(n)有明显的性能提升，所以这种情况Redis会采用一种更为紧凑但性能较差的内部编码方式。

内部编码方式对开发者来说是透明的，Redis会根据实际情况自行调整。

<b>查看一个键的内部编码方式</b>
```
OBJECT ENCODING key
```

每一个键都是使用一个RedisObject结构体保存的，redisObject的定义如下：
```
typedef struct redisObject {
    unsigned type:4;
    unsigned notused:2
    unsigned encoding:4
    unsigned lru:22;
    int refcount;
    void *ptr
}robj;
```

type字段表示的是键值的类型
|类型|值|
|--|--|
|REDIS_STRING|0|
|REDIS_LIST|1|
|REDIS_SET|2|
|REDIS_ZSET|3|
|REDIS_HASH|4|

encoding字段表示的是编码方式
|数据类型|编码方式|命令返回结果|
|--|--|--|
|字符串类型|REDIS_ENCODING_RAW|raw|
||REDIS_ENCODING_INT|int|
|散列类型|REDIS_ENCODING_HT|hashtable|
||REDIS_ENCODING_ZIPLIST|ziplist|
|列表类型|REDIS_ENCODING_LINKEDLIST|linkedlist|
||REDIS_ENCODING_ZIPLIST|ziplist|
|集合类型|REDIS_ENCODING_HT|hashtable|
||REDIS_ENCODING_INTSET|intset|
|有序集合类型|REDIS_ENCODING_SKIPLIST|skiplist|
||REDIS_ENCODING_ZIPLIST|ziplist|
PS「后续新版本Redis有添加新的编码类型，感兴趣的自行查阅文档了解」

以下针对每种数据类型分别介绍其内部编码规则及优化方式。

**1.字符串类型**
